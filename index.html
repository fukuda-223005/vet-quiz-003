<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç£åŒ»å¸«å›½è©¦å¯¾ç­– - GIåˆ¶è¦‡ã¸ã®é“</title>
  <style>
    :root {
      --primary: #2c3e50;
      --main-btn: #3498db;
      --accent: #27ae60;
      --bg: #f4f7f6;
      --grass: #7cfc00;
      --track: #d2b48c;
      --gold: #f1c40f;
      --text: #333;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
      touch-action: manipulation;
      overflow-x: hidden;
    }

    /* === ãƒ¬ãƒ¼ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ === */
    .race-monitor {
      background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 60%, var(--grass) 60%, var(--grass) 75%, var(--track) 75%);
      padding: 15px;
      text-align: center;
      border-bottom: 4px solid #8d6e63;
      position: relative;
      height: 180px;
      overflow: hidden;
    }

    .race-info {
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 15px;
      border-radius: 20px;
      display: inline-block;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 10px;
      z-index: 10;
      position: relative;
    }

    .class-badge {
      font-weight: bold;
      font-size: 1.2em;
      color: var(--primary);
      margin-right: 10px;
      padding: 2px 8px;
      border: 2px solid var(--primary);
      border-radius: 4px;
    }

    .time-text {
      font-family: 'Courier New', Courier, monospace;
      font-weight: bold;
      font-size: 1.2em;
      color: #d35400;
    }

    /* ãƒˆãƒ©ãƒƒã‚¯ã¨é¦¬ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .track-lane {
      position: absolute;
      bottom: 20px;
      left: 10%;
      right: 10%;
      height: 4px;
      background: rgba(255,255,255,0.6);
      border-radius: 2px;
    }

    .goal-post {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 4px;
      height: 30px;
      background: #e74c3c;
    }
    .goal-flag {
      position: absolute;
      right: -5px;
      bottom: 30px;
      font-size: 20px;
    }

    #horse-icon {
      position: absolute;
      bottom: -10px;
      left: 0%;
      font-size: 40px;
      transition: left 0.5s ease-out, transform 0.2s;
      transform: scaleX(-1);
      filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
      z-index: 5;
    }
    
    #live-commentary {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold;
      text-shadow: 1px 1px 0 #fff;
      color: #d35400;
      width: 90%;
      font-size: 0.95em;
    }

    /* === ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ === */
    .quiz-container {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .question-box {
      font-size: 1.1em;
      line-height: 1.6;
      margin-bottom: 25px;
      border-left: 5px solid var(--main-btn);
      padding-left: 15px;
    }

    .options-grid {
      display: grid;
      gap: 12px;
    }

    .option-btn {
      background: #fff;
      border: 2px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.2s;
      position: relative;
    }

    .option-btn:hover {
      background-color: #f8f9fa;
      border-color: #b0bec5;
    }

    .option-btn.selected {
      background-color: #e3f2fd;
      border-color: var(--main-btn);
      color: var(--main-btn);
      font-weight: bold;
    }

    .option-btn.correct {
      background-color: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .option-btn.wrong {
      background-color: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    #confirm-btn {
      display: none;
      width: 100%;
      margin-top: 20px;
      padding: 15px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
    }

    #feedback-area {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #f1f8e9;
      border-radius: 8px;
      border: 1px solid #c5e1a5;
    }

    #next-btn {
      width: 100%;
      margin-top: 15px;
      padding: 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
    }

    /* === è¨­å®šãƒ»çµæœç”»é¢ === */
    #start-screen, #result-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.98);
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
    }
    
    .hidden { display: none !important; }

    h1 { color: var(--primary); margin-bottom: 10px; }
    h2 { color: var(--main-btn); margin-bottom: 20px; }
    
    .config-group { margin: 15px 0; text-align: left; width: 100%; max-width: 300px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    select, button { width: 100%; padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; }
    
    .primary-btn {
      background: var(--main-btn); color: white; border: none; font-weight: bold; margin-top: 10px;
      box-shadow: 0 4px 0 #2980b9;
    }
    .primary-btn:active { box-shadow: 0 2px 0 #2980b9; transform: translateY(2px); }
    .reset-btn { background: #95a5a6; color: white; border: none; margin-top: 10px; font-size: 0.8em; }

    @media (max-width: 480px) {
      .race-monitor { height: 160px; }
      #horse-icon { font-size: 32px; }
    }
  </style>
</head>
<body>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <div id="start-screen">
    <h1>ğŸ† GIåˆ¶è¦‡ã¸ã®é“</h1>
    <p>ç£åŒ»å¸«å›½å®¶è©¦é¨“å¯¾ç­– (ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯)</p>
    
    <div id="current-rank-display" style="margin: 10px 0; font-size: 1.2em; color: #d35400;">
      ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹: <span id="start-class-name">æ–°é¦¬æˆ¦</span>
      <br><span style="font-size:0.8em; color:#555;">ç›®æ¨™(1ç€): <span id="start-target-time">--</span>ç§’ä»¥å†…</span>
    </div>

    <div class="config-group">
      <label>å‡ºé¡Œç¯„å›²</label>
      <select id="category-select">
        <option value="A">å­¦èª¬Aï¼ˆåŸºç¤ï¼‰</option>
        <option value="B">å­¦èª¬Bï¼ˆè‡¨åºŠãƒ»å¿œç”¨ï¼‰</option>
        <option value="ALL">å…¨ç¯„å›² (A+B)</option>
      </select>
    </div>

    <div class="config-group">
      <label>å‡ºèµ°é¦¬</label>
      <select id="horse-color-select">
        <option value="ğŸ´">é¹¿æ¯›</option>
        <option value="ğŸ">é»’é¹¿æ¯›</option>
        <option value="ğŸ¦„">èŠ¦æ¯›</option>
        <option value="ğŸ¦“">ç¸</option>
      </select>
    </div>

    <div class="config-group">
      <button class="primary-btn" onclick="startGame()">å‡ºèµ°ã™ã‚‹ï¼</button>
      <button class="reset-btn" onclick="resetGame()">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰</button>
    </div>
  </div>

  <!-- ãƒ¬ãƒ¼ã‚¹ç”»é¢ -->
  <header class="race-monitor">
    <div class="race-info">
      <span class="class-badge" id="monitor-class-name">G1</span>
      <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
      <span class="time-text">TIME <span id="race-timer">0.0</span>s</span>
      <br>
      <span class="status-text" style="font-size:0.8em;">ã‚¯ãƒªã‚¢ã¾ã§ã‚ã¨ <span id="q-remain">10</span> å•</span>
    </div>
    <div id="live-commentary">ã‚²ãƒ¼ãƒˆå…¥ã‚Šã¾ã—ãŸ...</div>

    <div class="track-lane">
      <div id="horse-icon">ğŸ´</div>
      <div class="goal-post"></div>
      <div class="goal-flag">ğŸš©</div>
    </div>
  </header>

  <main class="quiz-container">
    <div id="question-text" class="question-box">èª­ã¿è¾¼ã¿ä¸­...</div>
    
    <div id="options-area" class="options-grid"></div>

    <button id="confirm-btn" onclick="checkAnswerMulti()">æ±ºå®š</button>

    <div id="feedback-area">
      <h3 id="feedback-title"></h3>
      <p id="feedback-text"></p>
      <button id="next-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
    </div>
  </main>

  <!-- çµæœç”»é¢ -->
  <div id="result-screen" class="hidden">
    <h1 id="rank-emoji">ğŸ¥‡</h1>
    <h2 id="rank-text">1ç€ï¼</h2>
    <p id="result-msg" style="margin-bottom:20px;">è¦‹äº‹ãªã‚¿ã‚¤ãƒ ã§ã‚´ãƒ¼ãƒ«ï¼</p>
    
    <div style="background:#eee; padding:15px; border-radius:8px; width:80%; max-width:400px; margin-bottom:20px;">
      <p>èµ°ç ´æ™‚è¨ˆ: <span id="final-time" style="font-weight:bold; font-size:1.5em; color:#d35400;">0.0</span> ç§’</p>
      
      <!-- ç€é †åŸºæº–è¡¨ -->
      <div style="text-align:left; font-size:0.85em; color:#555; margin-top:10px; line-height:1.4;">
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd;">
           <span>1ç€åŸºæº–:</span> <span><span id="res-target-1">--</span>ç§’ä»¥å†…</span>
        </div>
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd;">
           <span>2ç€(+2s):</span> <span><span id="res-target-2">--</span>ç§’ä»¥å†…</span>
        </div>
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd;">
           <span>3ç€(+5s):</span> <span><span id="res-target-3">--</span>ç§’ä»¥å†…</span>
        </div>
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd;">
           <span>4ç€(+8s):</span> <span><span id="res-target-4">--</span>ç§’ä»¥å†…</span>
        </div>
        <div style="display:flex; justify-content:space-between;">
           <span>5ç€(+11s):</span> <span><span id="res-target-5">--</span>ç§’ä»¥å†…</span>
        </div>
      </div>

      <hr style="border:1px solid #ddd; margin:10px 0;">
      <p id="promotion-msg" style="color:#27ae60; font-weight:bold;"></p>
    </div>

    <button class="primary-btn" id="next-race-btn" onclick="location.reload()">æ¬¡ã®ãƒ¬ãƒ¼ã‚¹ã¸</button>
  </div>

<script>
  // --- 1. å®šæ•°ãƒ»è¨­å®š ---
  // ã‚¯ãƒ©ã‚¹å®šç¾© (12æ®µéš) + 1ç€åŸºæº–ã‚¿ã‚¤ãƒ (ç§’)
  const CLASS_INFO = [
    { id: 0, name: "æ–°é¦¬æˆ¦", targetTime: 180 },
    { id: 1, name: "æœªå‹åˆ©", targetTime: 180 },
    { id: 2, name: "1å‹ã‚¯ãƒ©ã‚¹", targetTime: 160 },
    { id: 3, name: "2å‹ã‚¯ãƒ©ã‚¹", targetTime: 150 },
    { id: 4, name: "3å‹ã‚¯ãƒ©ã‚¹", targetTime: 140 },
    { id: 5, name: "ã‚ªãƒ¼ãƒ—ãƒ³ç‰¹åˆ¥", targetTime: 130 },
    { id: 6, name: "ãƒªã‚¹ãƒ†ãƒƒãƒ‰", targetTime: 120 },
    { id: 7, name: "G3", targetTime: 100 },
    { id: 8, name: "G2", targetTime: 90 },
    { id: 9, name: "G1", targetTime: 80 },         // 1ç€ã§ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼†æœ‰é¦¬æ¨©
    { id: 10, name: "æœ‰é¦¬è¨˜å¿µ", targetTime: 70 },   // 1ç€ã§å‡±æ—‹é–€ã¸ã€‚è² ã‘ã‚‹ã¨G1ã¸
    { id: 11, name: "å‡±æ—‹é–€è³", targetTime: 60 }   // 1ç€ã§çœŸã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€‚ãã®å¾ŒG1ã¸
  ];

  let allData = { single: [], multi: [] };
  
  // ãƒ¬ãƒ¼ã‚¹é€²è¡Œç”¨å¤‰æ•°
  let questionQueue = [];
  let retryQueue = [];
  let currentQData = null;
  let userSelection = [];
  
  let startTime = 0;
  let timerInterval = null;
  let clearedCount = 0;
  const TOTAL_QUESTIONS = 10;

  // æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿
  let savedState = {
    classId: 0,
    horseColor: "ğŸ´",
    category: "A"
  };

  // --- 2. åˆæœŸåŒ– ---
  window.onload = async () => {
    loadState();
    updateStartScreen();
    
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    try {
      const res = await fetch('/api/quiz_data');
      allData = await res.json();
    } catch (e) {
      alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  };

  function loadState() {
    // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³v4 (ãƒ«ãƒ¼ãƒ«å¤‰æ›´ã®ãŸã‚)
    const s = localStorage.getItem('vetQuizState_v4');
    if (s) savedState = JSON.parse(s);
    
    document.getElementById('category-select').value = savedState.category;
    document.getElementById('horse-color-select').value = savedState.horseColor;
  }

  function saveState() {
    savedState.category = document.getElementById('category-select').value;
    savedState.horseColor = document.getElementById('horse-color-select').value;
    localStorage.setItem('vetQuizState_v4', JSON.stringify(savedState));
  }

  function updateStartScreen() {
    const cls = CLASS_INFO.find(c => c.id === savedState.classId) || CLASS_INFO[0];
    let name = cls.name;
    if(savedState.classId === 11) name += " ğŸ‡«ğŸ‡·";

    document.getElementById('start-class-name').textContent = name;
    document.getElementById('start-target-time').textContent = cls.targetTime;
  }

  function resetGame() {
    if(confirm("é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°é¦¬æˆ¦ã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem('vetQuizState_v4');
      location.reload();
    }
  }

  // --- 3. ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ­ãƒ¼ ---
  function startGame() {
    saveState();
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('horse-icon').textContent = savedState.horseColor;

    createRaceDeck();
    
    const cls = CLASS_INFO.find(c => c.id === savedState.classId);
    document.getElementById('monitor-class-name').textContent = cls.name;
    
    clearedCount = 0;
    updateProgress();
    
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 100);
    
    showQuestion();
  }

  function createRaceDeck() {
    const cat = savedState.category;
    let sPool = allData.single;
    let mPool = allData.multi;

    if (cat !== 'ALL') {
      sPool = sPool.filter(q => q.cat === cat);
      mPool = mPool.filter(q => q.cat === cat);
    }

    sPool = shuffle(sPool);
    mPool = shuffle(mPool);

    // å˜ä¸€7å• + è¤‡æ•°3å•
    const qSingle = sPool.slice(0, 7);
    const qMulti = mPool.slice(0, 3);
    
    questionQueue = shuffle([...qSingle, ...qMulti]);
    retryQueue = [];

    if (questionQueue.length === 0) {
      alert("å•é¡Œãƒ‡ãƒ¼ã‚¿ä¸è¶³ã§ã™ã€‚");
      location.reload();
    }
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function updateTimer() {
    const now = Date.now();
    const diff = (now - startTime) / 1000;
    document.getElementById('race-timer').textContent = diff.toFixed(1);
  }

  // --- 4. ã‚¯ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯ ---
  function showQuestion() {
    if (questionQueue.length === 0) {
      if (retryQueue.length > 0) {
        questionQueue = shuffle([...retryQueue]);
        retryQueue = [];
        const comm = document.getElementById('live-commentary');
        comm.textContent = "æœ€å¾Œã®ç›´ç·šï¼é£Ÿã‚‰ã„ã¤ã‘ï¼ï¼ˆèª¤ç­”ã®å†å‡ºé¡Œï¼‰";
        comm.style.color = "#e74c3c";
      } else {
        finishRace();
        return;
      }
    }

    currentQData = questionQueue.shift();
    userSelection = [];

    const totalRemaining = questionQueue.length + retryQueue.length + 1;
    document.getElementById('q-remain').textContent = totalRemaining;
    document.getElementById('question-text').textContent = currentQData.q;
    document.getElementById('feedback-area').style.display = 'none';
    document.getElementById('confirm-btn').style.display = 'none';

    // å®Ÿæ³
    const comm = document.getElementById('live-commentary');
    if (retryQueue.length === 0 && questionQueue.length > 5) {
      comm.textContent = "é †èª¿ãªãƒšãƒ¼ã‚¹ã§ã™ï¼";
      comm.style.color = "#d35400";
    }

    // é¸æŠè‚¢
    const optionsArea = document.getElementById('options-area');
    optionsArea.innerHTML = '';
    const isMulti = currentQData.a.length > 1;
    if (isMulti) {
      document.getElementById('question-text').innerHTML += " <br><span style='color:red; font-size:0.8em;'>â€»è¤‡æ•°é¸æŠ(" + currentQData.a.length + "ã¤)</span>";
      document.getElementById('confirm-btn').style.display = 'block';
    }

    currentQData.c.forEach((optText, idx) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.textContent = optText;
      const optId = idx + 1;

      btn.onclick = () => {
        if (document.getElementById('feedback-area').style.display === 'block') return;
        if (isMulti) {
          toggleSelection(btn, optId);
        } else {
          checkAnswerSingle(optId, btn);
        }
      };
      optionsArea.appendChild(btn);
    });
  }

  function toggleSelection(btn, optId) {
    if (userSelection.includes(optId)) {
      userSelection = userSelection.filter(id => id !== optId);
      btn.classList.remove('selected');
    } else {
      if (userSelection.length < currentQData.a.length) {
        userSelection.push(optId);
        btn.classList.add('selected');
      }
    }
  }

  function checkAnswerSingle(selectedId, btnElement) {
    const isCorrect = currentQData.a.includes(selectedId);
    showFeedback(isCorrect, [selectedId]);
  }

  function checkAnswerMulti() {
    if (userSelection.length === 0) return;
    const correctSorted = [...currentQData.a].sort().toString();
    const userSorted = [...userSelection].sort().toString();
    const isCorrect = (correctSorted === userSorted);
    showFeedback(isCorrect, userSelection);
  }

  function showFeedback(isCorrect, userSelectedIds) {
    const feedbackArea = document.getElementById('feedback-area');
    const title = document.getElementById('feedback-title');
    const text = document.getElementById('feedback-text');
    const comm = document.getElementById('live-commentary');

    const buttons = document.querySelectorAll('.option-btn');
    buttons.forEach((btn, idx) => {
      const optId = idx + 1;
      if (currentQData.a.includes(optId)) btn.classList.add('correct');
      if (userSelectedIds.includes(optId) && !currentQData.a.includes(optId)) btn.classList.add('wrong');
    });

    feedbackArea.style.display = 'block';
    
    if (isCorrect) {
      title.textContent = "â­• æ­£è§£ï¼";
      title.style.color = "#27ae60";
      text.textContent = currentQData.e;
      comm.textContent = "è‰¯ã„åå¿œã§ã™ï¼åŠ é€Ÿï¼";
      clearedCount++;
      updateProgress();
    } else {
      title.textContent = "âŒ ä¸æ­£è§£...";
      title.style.color = "#c0392b";
      text.textContent = "æ­£è§£: " + currentQData.e;
      comm.textContent = "ãŠã£ã¨ã€è¶³è‰²ãŒéˆã£ãŸï¼";
      retryQueue.push(currentQData);
    }
    
    document.getElementById('confirm-btn').style.display = 'none';
  }

  function updateProgress() {
    const horse = document.getElementById('horse-icon');
    const percent = (clearedCount / TOTAL_QUESTIONS) * 90; 
    horse.style.left = Math.min(percent, 90) + '%';
  }

  function nextQuestion() {
    showQuestion();
  }

  // --- 5. ç€é †åˆ¤å®šã¨çµæœ ---
  function getRank(time, target) {
    if (time <= target) return 1;
    if (time <= target + 2) return 2;
    if (time <= target + 5) return 3;
    if (time <= target + 8) return 4;
    if (time <= target + 11) return 5;
    return 6; // ç€å¤–
  }

  function finishRace() {
    clearInterval(timerInterval);
    const finishTime = (Date.now() - startTime) / 1000;
    
    document.getElementById('horse-icon').style.left = '95%';

    const currentClass = CLASS_INFO.find(c => c.id === savedState.classId);
    const target = currentClass.targetTime;
    const rank = getRank(finishTime, target);

    const resultScreen = document.getElementById('result-screen');
    const rankEmojiEl = document.getElementById('rank-emoji');
    const rankTextEl = document.getElementById('rank-text');
    const msgEl = document.getElementById('result-msg');
    const promMsgEl = document.getElementById('promotion-msg');
    const nextBtnEl = document.getElementById('next-race-btn');
    
    resultScreen.classList.remove('hidden');
    document.getElementById('final-time').textContent = finishTime.toFixed(2);
    
    // åŸºæº–ã‚¿ã‚¤ãƒ è¡¨ç¤ºæ›´æ–°
    document.getElementById('res-target-1').textContent = target;
    document.getElementById('res-target-2').textContent = target + 2;
    document.getElementById('res-target-3').textContent = target + 5;
    document.getElementById('res-target-4').textContent = target + 8;
    document.getElementById('res-target-5').textContent = target + 11;

    // ç€é †è¡¨ç¤º
    if (rank === 1) {
      rankTextEl.textContent = "1ç€"; rankTextEl.style.color = "#e67e22"; rankEmojiEl.textContent = "ğŸ¥‡";
      msgEl.textContent = "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å‹åˆ©ã§ã™ï¼";
    } else if (rank <= 5) {
      rankTextEl.textContent = rank + "ç€"; rankTextEl.style.color = "#34495e"; rankEmojiEl.textContent = "ğŸ¥ˆ";
      msgEl.textContent = "æƒœæ•—... ã“ã®ã‚¯ãƒ©ã‚¹ã§å†æŒ‘æˆ¦ã§ã™ã€‚";
    } else {
      rankTextEl.textContent = "ç€å¤–"; rankTextEl.style.color = "#95a5a6"; rankEmojiEl.textContent = "â˜ï¸";
      msgEl.textContent = "æ®‹å¿µ... ã¾ã ã¾ã å¼·ããªã‚Œã‚‹ï¼æ¬¡èµ°ã“ãå‹åˆ©ã‚’ï¼";
    }

    // --- æ˜‡æ ¼ãƒ»é™æ ¼ãƒ­ã‚¸ãƒƒã‚¯ ---
    const currentClassId = savedState.classId;
    let nextClassId = currentClassId;

    if (currentClassId <= 8) { 
      // --- æ–°é¦¬æˆ¦(0) ã€œ G2(8) ---
      // åŸºæœ¬: é™æ ¼ãªã—
      // 1ç€ -> æ˜‡æ ¼
      // 2ç€ä»¥ä¸‹ -> ç¶­æŒ
      if (rank === 1) {
        nextClassId = currentClassId + 1;
        const nextName = CLASS_INFO.find(c => c.id === nextClassId).name;
        promMsgEl.innerHTML = `ã‚¯ãƒ©ã‚¹æ˜‡æ ¼ï¼<br>æ¬¡ã¯ã€Œ${nextName}ã€ã¸å‡ºèµ°ã—ã¾ã™ï¼`;
      } else {
        promMsgEl.innerHTML = `åŒã‚¯ãƒ©ã‚¹ç¶­æŒã€‚<br>æ¬¡ã“ãã¯å‹åˆ©ã‚’æ´ã¿ã¾ã—ã‚‡ã†ï¼`;
      }

    } else if (currentClassId === 9) { 
      // --- G1 (9) ---
      // 1ç€ -> ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æ¼”å‡º & æœ‰é¦¬è¨˜å¿µã¸
      // 2ç€ä»¥ä¸‹ -> ç¶­æŒ
      if (rank === 1) {
        alert("ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ G1åˆ¶è¦‡é”æˆã§ã™ï¼ ğŸ‰\n\nã—ã‹ã—ã€ã¾ã æˆ¦ã„ã¯çµ‚ã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚°ãƒ©ãƒ³ãƒ—ãƒªã€Œæœ‰é¦¬è¨˜å¿µã€ã¸ã®å‡ºèµ°æ¨©ãŒä¸ãˆã‚‰ã‚Œã¾ã—ãŸï¼");
        nextClassId = 10;
        promMsgEl.innerHTML = `G1åˆ¶è¦‡é”æˆï¼ï¼<br>ç‰¹åˆ¥æ‹›å¾…:ã€Œæœ‰é¦¬è¨˜å¿µã€ã¸æŒ‘æˆ¦ã—ã¾ã™ï¼`;
        nextBtnEl.textContent = "æœ‰é¦¬è¨˜å¿µã¸å‡ºèµ°";
      } else {
        promMsgEl.innerHTML = `G1ã®å£ã¯åšã„...<br>è«¦ã‚ãšã«å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼`;
      }

    } else if (currentClassId === 10) { 
      // --- æœ‰é¦¬è¨˜å¿µ (10) ---
      // 1ç€ -> å‡±æ—‹é–€è³ã¸
      // 2ç€ä»¥ä¸‹ -> G1ã¸æˆ»ã‚‹
      if (rank === 1) {
        alert("ğŸ† æœ‰é¦¬è¨˜å¿µ å„ªå‹ï¼ ğŸ†\n\næ—¥æœ¬æœ€å¼·ã®è¨¼æ˜ã¯æ¸ˆã¿ã¾ã—ãŸã€‚\nä¸–ç•Œã¸ã®æŒ‘æˆ¦æ¨©...ã€Œå‡±æ—‹é–€è³ã€ã¸æŒ‘ã¿ã¾ã™ã‹ï¼Ÿ");
        nextClassId = 11;
        promMsgEl.innerHTML = `ã‚°ãƒ©ãƒ³ãƒ—ãƒªåˆ¶è¦‡ï¼ï¼<br>ã„ã–ã€ä¸–ç•Œã¸ã€‚ã€Œå‡±æ—‹é–€è³ã€æŒ‘æˆ¦ï¼`;
        nextBtnEl.textContent = "ãƒ•ãƒ©ãƒ³ã‚¹ã¸é å¾ã™ã‚‹";
      } else {
        nextClassId = 9; // G1ã¸æˆ»ã‚‹
        promMsgEl.innerHTML = `æ®‹å¿µ...<br>G1æˆ¦ç·šã¸æˆ»ã‚Šã€å†ã³æ‹›å¾…ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ã€‚`;
        nextBtnEl.textContent = "G1ã¸æˆ»ã‚‹";
      }

    } else if (currentClassId === 11) {
      // --- å‡±æ—‹é–€è³ (11) ---
      // 1ç€ -> çœŸã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° & G1ã¸
      // 2ç€ä»¥ä¸‹ -> G1ã¸
      if (rank === 1) {
        alert("ğŸ‡«ğŸ‡· å‡±æ—‹é–€è³ åˆ¶è¦‡ï¼ï¼ï¼ ğŸ‡«ğŸ‡·\n\nä¸–ç•Œæœ€å¼·ã®ç£åŒ»å¸«ã®èª•ç”Ÿã§ã™ï¼\nã“ã‚Œã«ã¦å®Œå…¨ã‚¯ãƒªã‚¢ã¨ãªã‚Šã¾ã™ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼");
        promMsgEl.innerHTML = `ä¼èª¬é”æˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>å‡±æ—‹é–€è³ã‚¦ã‚£ãƒŠãƒ¼ã¨ã—ã¦G1ã‚’é˜²è¡›ã—ã¾ã—ã‚‡ã†ã€‚`;
      } else {
        promMsgEl.innerHTML = `ä¸–ç•Œã®å£ã¯é«˜ã‹ã£ãŸ...<br>å¸°å›½ã—ã¦G1ã‹ã‚‰å‡ºç›´ã—ã¾ã™ã€‚`;
      }
      // ã©ã£ã¡ã«ã—ã‚G1ã¸æˆ»ã‚‹
      nextClassId = 9;
      nextBtnEl.textContent = "å¸°å›½ã™ã‚‹ (G1ã¸)";
    }

    savedState.classId = nextClassId;
    saveState();
  }
</script>
</body>
</html>