<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç£åŒ»å¸«å›½è©¦å¯¾ç­– - GIåˆ¶è¦‡ã¸ã®é“</title>
  <style>
    :root {
      --primary: #2c3e50;
      --main-btn: #3498db;
      --accent: #27ae60;
      --bg: #f4f7f6;
      --grass: #7cfc00;
      --track: #d2b48c;
      --text: #333;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
      touch-action: manipulation;
      overflow-x: hidden;
      user-select: none;
    }

    /* === ç”»é¢ç®¡ç† === */
    .screen {
      display: none;
      width: 100%;
      height: 100vh;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0; left: 0;
      background: #fff;
      z-index: 10;
    }
    .screen.active {
      display: flex;
    }

    /* === ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ === */
    #screen-loading {
      background: var(--bg);
      color: #7f8c8d;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--main-btn);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* === ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ === */
    #screen-start {
      background: rgba(255,255,255,0.98);
      padding: 20px;
      text-align: center;
      overflow-y: auto;
    }
    
    .start-content {
      max-width: 500px;
      width: 100%;
    }

    h1 { color: var(--primary); margin-bottom: 5px; font-size: 1.5em; }
    h2 { color: #e67e22; margin-top: 0; font-size: 1.2em; }
    
    .config-box {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      background: #f9f9f9;
    }

    /* é¦¬é¸æŠã‚«ãƒ¼ãƒ‰ */
    .horse-select-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .horse-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .horse-card:hover {
      border-color: #bdc3c7;
      background: #fdfdfd;
    }
    .horse-card.selected {
      border-color: var(--main-btn);
      background: #e3f2fd;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
    }
    
    .horse-img-placeholder {
      width: 60px;
      height: 60px;
      margin-bottom: 5px;
    }
    .horse-name {
      font-weight: bold;
      font-size: 0.9em;
      color: #555;
    }
    .horse-card.selected .horse-name {
      color: var(--main-btn);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    
    .select-btn {
      padding: 8px 12px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .select-btn.selected {
      background: var(--main-btn);
      color: #fff;
      border-color: var(--main-btn);
    }

    .primary-btn {
      width: 100%;
      padding: 15px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 0 #c0392b;
    }
    .primary-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #c0392b;
    }

    /* === ãƒ¬ãƒ¼ã‚¹ç”»é¢ === */
    #screen-race {
      display: none;
      flex-direction: column;
      justify-content: flex-start;
      height: 100vh;
      background: #fff;
    }
    #screen-race.active {
      display: flex;
    }

    /* ãƒ¬ãƒ¼ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆä¸Šéƒ¨ï¼‰ */
    .race-monitor {
      flex: 0 0 200px;
      background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 50%, var(--grass) 50%, var(--grass) 70%, var(--track) 70%);
      position: relative;
      overflow: hidden;
      border-bottom: 4px solid #8d6e63;
    }

    .race-hud {
      position: absolute;
      top: 10px; left: 10px; right: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 20;
    }

    .badge {
      background: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .badge-gold { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }

    .timer-box {
      background: rgba(0,0,0,0.7);
      color: #f1c40f;
      padding: 5px 12px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 1.2em;
    }

    /* é¦¬ã®è¡¨ç¾ (SVGç”¨) */
    .horse-sprite {
      position: absolute;
      width: 60px;
      height: 40px;
      transition: left 0.5s cubic-bezier(0.25, 0.1, 0.25, 1.0), top 0.5s ease;
      /* SVGå†…éƒ¨ã§åè»¢ã•ã›ã‚‹ã®ã§CSS transformã¯å‰Šé™¤ */
    }
    
    .anim-run {
      animation: galloping 0.4s infinite alternate;
    }
    @keyframes galloping {
      0% { transform: translateY(0); }
      100% { transform: translateY(-3px); }
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¦¬: æ‰‹å‰ã«è¡¨ç¤º */
    #player-horse {
      bottom: 20px;
      left: 50%; /* åˆæœŸä½ç½®ï¼šä¸­å¤® */
      z-index: 10;
      width: 80px; /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å°‘ã—å¤§ãã */
      height: 54px;
      filter: drop-shadow(0px 0px 5px rgba(255, 255, 255, 0.8)); /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¼·èª¿ */
    }

    /* ãƒ©ã‚¤ãƒãƒ«é¦¬ */
    .horse-rival {
      width: 50px;
      height: 34px;
      opacity: 0.95;
      z-index: 5;
    }

    /* ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ï¼‰ */
    .quiz-area {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #fff;
    }
    
    .question-text {
      font-size: 1.1em;
      margin-bottom: 15px;
      line-height: 1.5;
      border-left: 4px solid var(--main-btn);
      padding-left: 10px;
    }

    .choices-grid {
      display: grid;
      gap: 10px;
    }

    .choice-btn {
      padding: 12px;
      border: 2px solid #eee;
      background: #fff;
      border-radius: 6px;
      text-align: left;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
    }
    .choice-btn:active { background: #f0f0f0; }
    .choice-btn.selected { background: #e3f2fd; border-color: var(--main-btn); color: var(--main-btn); font-weight: bold; }
    .choice-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
    .choice-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }

    #confirm-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      margin-top: 15px;
      font-size: 1.1em;
      font-weight: bold;
      display: none;
    }

    /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    #feedback-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .feedback-box {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .fb-title { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
    .fb-correct { color: #27ae60; }
    .fb-wrong { color: #c0392b; }
    .fb-desc { text-align: left; margin: 15px 0; line-height: 1.5; font-size: 0.95em; }

    /* çµæœç”»é¢ */
    #screen-result {
      background: #fff;
      text-align: center;
      padding: 20px;
    }
    .rank-large { font-size: 4em; margin: 10px 0; }
    .result-time { font-size: 2em; font-weight: bold; color: var(--primary); }
    .result-table { margin: 20px auto; width: 100%; max-width: 300px; font-size: 0.9em; text-align: left; }
    .result-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }

  </style>
</head>
<body>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
  <div id="screen-loading" class="screen active">
    <div class="loading-spinner"></div>
    <div id="loading-text">å‡ºèµ°æº–å‚™ä¸­...</div>
    <div style="font-size:0.8em; color:#999; margin-top:10px;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼šä¸­...</div>
  </div>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <div id="screen-start" class="screen">
    <div class="start-content">
      <h1>ğŸ† GIåˆ¶è¦‡ã¸ã®é“</h1>
      <h2 id="current-class-display">æ–°é¦¬æˆ¦</h2>
      
      <div id="current-status-display" style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:10px;">
        <div id="current-horse-icon" style="width:50px; height:34px;"></div>
        <span id="current-category-display" style="font-weight:bold; color:#555;">ç¯„å›²: Aå•é¡Œ</span>
      </div>

      <p style="margin:5px 0;">ç›®æ¨™ã‚¿ã‚¤ãƒ : <span id="target-time-display" style="font-weight:bold; color:#d35400;">120</span>ç§’ä»¥å†…</p>

      <div id="setup-area-wrapper">
        <div class="config-box">
          <label>å‡ºé¡Œç¯„å›²</label>
          <div class="btn-group">
            <div id="cat-a" class="select-btn selected" onclick="selectCategory('A')">A(åŸºç¤)</div>
            <div id="cat-b" class="select-btn" onclick="selectCategory('B')">B(è‡¨åºŠ)</div>
            <div id="cat-all" class="select-btn" onclick="selectCategory('ALL')">å…¨ç¯„å›²</div>
          </div>
        </div>

        <div class="config-box">
          <label>å‡ºèµ°é¦¬ã‚’é¸æŠ</label>
          <div class="horse-select-grid">
            <div id="sel-brown" class="horse-card selected" onclick="selectHorse('brown')">
              <div class="horse-img-placeholder" id="img-brown"></div>
              <div class="horse-name">é¹¿æ¯› (èŒ¶)</div>
            </div>
            <div id="sel-black" class="horse-card" onclick="selectHorse('black')">
              <div class="horse-img-placeholder" id="img-black"></div>
              <div class="horse-name">é»’é¹¿æ¯› (é»’)</div>
            </div>
            <div id="sel-gray" class="horse-card" onclick="selectHorse('gray')">
              <div class="horse-img-placeholder" id="img-gray"></div>
              <div class="horse-name">èŠ¦æ¯› (ç™½)</div>
            </div>
            <div id="sel-zebra" class="horse-card" onclick="selectHorse('zebra')">
              <div class="horse-img-placeholder" id="img-zebra"></div>
              <div class="horse-name">ã‚·ãƒã‚¦ãƒ</div>
            </div>
          </div>
        </div>
      </div>

      <button class="primary-btn" onclick="startRace()">å‡ºèµ°ã™ã‚‹ï¼</button>
      
      <div style="margin-top:20px;">
        <button onclick="resetData()" style="background:none; border:none; text-decoration:underline; color:#7f8c8d; cursor:pointer;">
          ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°é¦¬æˆ¦ã¸æˆ»ã‚‹
        </button>
      </div>
    </div>
  </div>

  <!-- ãƒ¬ãƒ¼ã‚¹ç”»é¢ -->
  <div id="screen-race" class="screen">
    <header class="race-monitor">
      <div class="race-hud">
        <span id="race-class-badge" class="badge">æ–°é¦¬æˆ¦</span>
        <div class="timer-box" id="timer">0.00</div>
        <span class="badge">æ®‹ã‚Š <span id="q-remain-count">10</span> å•</span>
      </div>
      
      <!-- ãƒ¬ãƒ¼ã‚¹ãƒˆãƒ©ãƒƒã‚¯ -->
      <div style="position:relative; top:60px; height:120px;">
        <!-- ãƒ©ã‚¤ãƒãƒ«é¦¬ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="rivals-container"></div>
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¦¬ -->
        <div id="player-horse" class="horse-sprite"></div>
      </div>
    </header>

    <main class="quiz-area">
      <div id="question-area">
        <!-- JSã§æç”» -->
      </div>
      <button id="confirm-btn" onclick="submitMultiAnswer()">æ±ºå®š</button>
    </main>
    
    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="feedback-overlay">
      <div class="feedback-box">
        <div id="fb-title" class="fb-title"></div>
        <div id="fb-text" class="fb-desc"></div>
        <button class="primary-btn" onclick="nextQuestion()">æ¬¡ã¸</button>
      </div>
    </div>
  </div>

  <!-- çµæœç”»é¢ -->
  <div id="screen-result" class="screen">
    <div id="result-emoji" class="rank-large">ğŸ¥‡</div>
    <h1 id="result-rank-text">1ç€</h1>
    <div class="result-time"><span id="result-time-val">0.00</span> ç§’</div>
    
    <div class="result-table">
      <div class="result-row"><span>ç›®æ¨™ã‚¿ã‚¤ãƒ </span><span id="res-target">--</span></div>
      <div class="result-row"><span>2ç€ãƒ©ã‚¤ãƒ³</span><span id="res-target-2">--</span></div>
      <div class="result-row"><span>3ç€ãƒ©ã‚¤ãƒ³</span><span id="res-target-3">--</span></div>
    </div>
    
    <div id="promotion-message" style="margin:20px 0; font-weight:bold; color:#27ae60; line-height:1.5;"></div>
    
    <button id="next-race-btn" class="primary-btn" onclick="location.reload()">æ¬¡ã®ãƒ¬ãƒ¼ã‚¹ã¸</button>
  </div>

<script>
  // === å®šæ•°ãƒ»è¨­å®š ===
  const CLASSES = [
    { id: 0, name: "æ–°é¦¬æˆ¦", target: 180 },
    { id: 1, name: "æœªå‹åˆ©", target: 180 },
    { id: 2, name: "1å‹ã‚¯ãƒ©ã‚¹", target: 160 },
    { id: 3, name: "2å‹ã‚¯ãƒ©ã‚¹", target: 150 },
    { id: 4, name: "3å‹ã‚¯ãƒ©ã‚¹", target: 140 },
    { id: 5, name: "ã‚ªãƒ¼ãƒ—ãƒ³ç‰¹åˆ¥", target: 130 },
    { id: 6, name: "ãƒªã‚¹ãƒ†ãƒƒãƒ‰", target: 120 },
    { id: 7, name: "G3", target: 100 },
    { id: 8, name: "G2", target: 90 },
    { id: 9, name: "G1", target: 80 },
    { id: 10, name: "æœ‰é¦¬è¨˜å¿µ", target: 70 },
    { id: 11, name: "å‡±æ—‹é–€è³", target: 60 }
  ];

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let allData = { single: [], multi: [] };
  let currentClassId = 0;
  let selectedCategory = 'A';
  let playerHorseColor = 'brown';
  
  // ãƒ¬ãƒ¼ã‚¹ç”¨
  let raceQuestions = [];
  let retryQueue = [];
  let currentQData = null;
  let selectedChoices = [];
  
  let startTime = 0;
  let timerInterval = null;
  let totalElapsed = 0; // ms
  
  // ä½ç½®æ¼”å‡ºç”¨å¤‰æ•°
  let playerPosition = 50; 
  const CENTER_POS = 50;
  const STEP_POS = 8; // æ­£è§£ã”ã¨ã®ç§»å‹•é‡
  const MIN_POS = 10;
  const MAX_POS = 90;

  // === SVGç”Ÿæˆé–¢æ•° ===
  // ã‚·ãƒ³ãƒ—ãƒ«ãªé¦¬ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆSVGã‚’ç”Ÿæˆã—ã¾ã™
  function getHorseSvg(color) {
    let bodyColor = '#8B4513'; // brown
    let strokeColor = 'none';
    let zebraStripes = '';
    
    if (color === 'black') bodyColor = '#2c3e50';
    if (color === 'gray') bodyColor = '#ecf0f1'; // æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼
    if (color === 'zebra') { 
      bodyColor = '#ffffff'; 
      strokeColor = '#000';
      // ã‚·ãƒã‚¦ãƒç”¨ã®ç¸æ¨¡æ§˜ãƒ‘ã‚¹
      zebraStripes = `<path d="M25,25 L35,15 M40,25 L50,15 M30,40 L40,30 M50,40 L60,30" stroke="black" stroke-width="2" />`;
    }

    // é¦¬ã®å½¢çŠ¶ãƒ‘ã‚¹ (å³å‘ã)
    const horsePath = `
      <g transform="scale(-1,1) translate(-100,0)"> <!-- å³å‘ãã«åè»¢ -->
        <!-- è„š -->
        <path d="M30,60 L30,90 L40,90 L40,60 Z" fill="${bodyColor}" stroke="#333" stroke-width="1"/>
        <path d="M70,60 L70,90 L80,90 L80,60 Z" fill="${bodyColor}" stroke="#333" stroke-width="1"/>
        <!-- ä½“ãƒ»é ­ -->
        <path d="M20,40 Q25,10 60,30 Q90,10 90,40 L90,60 L80,60 L80,50 L20,50 L20,60 L10,60 Z" fill="${bodyColor}" stroke="#333" stroke-width="1"/>
        <!-- ãŸã¦ãŒã¿/å°»å°¾ -->
        <path d="M10,40 Q0,50 5,70" stroke="#333" stroke-width="3" fill="none"/>
        ${zebraStripes}
        <!-- ç›® -->
        <circle cx="75" cy="35" r="2" fill="white"/>
        <circle cx="75" cy="35" r="1" fill="black"/>
      </g>
    `;

    return `<svg viewBox="0 0 100 100" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">${horsePath}</svg>`;
  }

  // === åˆæœŸåŒ– ===
  window.onload = function() {
    // é¸æŠç”»é¢ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ
    ['brown', 'black', 'gray', 'zebra'].forEach(c => {
      const el = document.getElementById(`img-${c}`);
      if(el) el.innerHTML = getHorseSvg(c);
    });

    loadSavedData();
    loadDataFromPython();
  };

  function loadSavedData() {
    const cid = localStorage.getItem('vetQuizClassId');
    if (cid !== null) currentClassId = parseInt(cid, 10);
    
    const cat = localStorage.getItem('vetQuizCategory');
    if (cat) {
      selectedCategory = cat;
      ['a', 'b', 'all'].forEach(id => document.getElementById(`cat-${id}`).classList.remove('selected'));
      document.getElementById(`cat-${cat.toLowerCase()}`).classList.add('selected');
    }

    const col = localStorage.getItem('vetQuizHorseColor');
    if (col) {
      playerHorseColor = col;
      updateHorseSelectUI(col);
    } else {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠUIåæ˜ 
      updateHorseSelectUI('brown');
    }
  }

  function loadDataFromPython() {
    console.log("Pythonã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™...");
    
    fetch('/api/quiz_data')
      .then(response => {
        if (!response.ok) { throw new Error('Network response was not ok'); }
        return response.json();
      })
      .then(data => {
        console.log("ãƒ‡ãƒ¼ã‚¿å—ä¿¡æˆåŠŸ:", data);
        onDataLoaded(data);
      })
      .catch(error => {
        console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        onDataError(error);
      });
  }

  function onDataLoaded(data) {
    allData = data;
    document.getElementById('screen-loading').classList.remove('active');
    document.getElementById('screen-start').classList.add('active');
    updateStartScreen();
  }

  function onDataError(e) {
    document.getElementById('loading-text').textContent = "ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
    alert("ã‚¨ãƒ©ãƒ¼: " + e + "\nã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }

  // === UIæ“ä½œ ===
  function selectCategory(cat) {
    selectedCategory = cat;
    ['a', 'b', 'all'].forEach(id => document.getElementById(`cat-${id}`).classList.remove('selected'));
    document.getElementById(`cat-${cat.toLowerCase()}`).classList.add('selected');
    localStorage.setItem('vetQuizCategory', cat);
    updateStartScreen();
  }

  function selectHorse(color) {
    playerHorseColor = color;
    updateHorseSelectUI(color);
    localStorage.setItem('vetQuizHorseColor', color);
  }

  function updateHorseSelectUI(color) {
    ['brown', 'black', 'gray', 'zebra'].forEach(c => {
      const el = document.getElementById(`sel-${c}`);
      if(el) el.classList.remove('selected');
    });
    const target = document.getElementById(`sel-${color}`);
    if(target) target.classList.add('selected');
  }

  function updateStartScreen() {
    const cls = CLASSES[currentClassId] || CLASSES[0];
    let displayName = cls.name;
    if(currentClassId === 11) displayName += " ğŸ‡«ğŸ‡·";
    
    document.getElementById('current-class-display').textContent = displayName;
    document.getElementById('target-time-display').textContent = cls.target;

    const titleEl = document.getElementById('current-class-display');
    if (currentClassId === 10) titleEl.style.color = "#d35400";
    else if (currentClassId === 11) titleEl.style.color = "#8e44ad";
    else titleEl.style.color = "#e67e22";

    const wrapper = document.getElementById('setup-area-wrapper');
    const statusDisplay = document.getElementById('current-status-display');
    
    if (currentClassId === 0) {
      wrapper.style.display = 'block';
      statusDisplay.style.display = 'none';
    } else {
      wrapper.style.display = 'none';
      statusDisplay.style.display = 'flex';
      
      // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ç¾åœ¨ã®é¦¬ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
      const iconDiv = document.getElementById('current-horse-icon');
      iconDiv.innerHTML = getHorseSvg(playerHorseColor);
      
      const catText = selectedCategory === 'ALL' ? 'å…¨ç¯„å›²' : `å­¦èª¬${selectedCategory}`;
      document.getElementById('current-category-display').textContent = catText;
    }
  }

  function resetData() {
    if(confirm("é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°é¦¬æˆ¦ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
      currentClassId = 0;
      localStorage.setItem('vetQuizClassId', 0);
      updateStartScreen();
    }
  }

  // === ãƒ¬ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ ===
  function getFilteredQuestions(list) {
    if (selectedCategory === 'ALL') return list;
    return list.filter(q => q.cat === selectedCategory);
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function startRace() {
    const filteredSingle = getFilteredQuestions(allData.single);
    const filteredMulti = getFilteredQuestions(allData.multi);

    if (filteredSingle.length < 7 || filteredMulti.length < 3) {
      alert(`å•é¡Œæ•°ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚\n(å˜ä¸€: ${filteredSingle.length}å•, è¤‡æ•°: ${filteredMulti.length}å•)\nç¯„å›²ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€CSVãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
      return;
    }

    const singles = shuffle([...filteredSingle]).slice(0, 7);
    const multis = shuffle([...filteredMulti]).slice(0, 3);
    
    raceQuestions = shuffle([...singles, ...multis]);
    retryQueue = [];
    
    document.getElementById('screen-start').classList.remove('active');
    document.getElementById('screen-race').classList.add('active');
    
    const cls = CLASSES[currentClassId];
    const badge = document.getElementById('race-class-badge');
    badge.textContent = cls.name;
    if (currentClassId >= 9) badge.classList.add('badge-gold');
    else badge.classList.remove('badge-gold');

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¦¬åˆæœŸåŒ– (SVG)
    const pHorse = document.getElementById('player-horse');
    pHorse.innerHTML = getHorseSvg(playerHorseColor);
    pHorse.className = `horse-sprite anim-run`; 
    
    // ä½ç½®åˆæœŸåŒ–ï¼ˆä¸­å›£ï¼‰
    playerPosition = CENTER_POS;
    updatePlayerPositionVisual();
    generateRivals();

    totalElapsed = 0;
    startTimer();
    showQuestion();
  }

  // ãƒ©ã‚¤ãƒãƒ«é¦¬ï¼ˆ9é ­ï¼‰ã®ç”Ÿæˆï¼šå›ºå®šä½ç½®ã§é›†å›£ã‚’ä½œã‚‹
  function generateRivals() {
    const container = document.getElementById('rivals-container');
    container.innerHTML = '';
    
    // ç”»é¢ã®å¹… 10% ã€œ 90% ã®é–“ã«9é ­ã‚’é…ç½®
    const colors = ['brown', 'black', 'gray', 'brown', 'black', 'brown']; // ãƒ©ã‚¤ãƒãƒ«ã®è‰²å€™è£œ

    for(let i=0; i<9; i++) {
      const rival = document.createElement('div');
      // ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã®SVGã‚’ç”Ÿæˆ
      const rndColor = colors[Math.floor(Math.random() * colors.length)];
      rival.innerHTML = getHorseSvg(rndColor);
      
      rival.className = 'horse-sprite anim-run horse-rival';
      // å°‘ã—è‰²å‘³ã‚’å¤‰ãˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿
      rival.style.filter = `hue-rotate(${Math.random() * 40}deg)`;
      
      const rTop = 20 + Math.random() * 70; // é«˜ã•ã°ã‚‰ã¤ã
      const rLeft = 15 + Math.random() * 70; // ä½ç½®ã°ã‚‰ã¤ã
      
      rival.style.top = rTop + 'px';
      rival.style.left = rLeft + '%';
      rival.style.animationDuration = (0.35 + Math.random() * 0.1) + 's';
      container.appendChild(rival);
    }
  }

  function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
      const now = Date.now();
      const diff = now - startTime + totalElapsed;
      const sec = Math.floor(diff / 1000);
      const ms = Math.floor((diff % 1000) / 10);
      document.getElementById('timer').textContent = sec + "." + (ms < 10 ? "0"+ms : ms);
    }, 50);
  }

  function stopTimer() {
    clearInterval(timerInterval);
    totalElapsed += Date.now() - startTime;
  }

  function updatePlayerPositionVisual() {
    const pHorse = document.getElementById('player-horse');
    pHorse.style.left = playerPosition + '%';
  }

  // === å•é¡Œè¡¨ç¤º ===
  function showQuestion() {
    if (raceQuestions.length === 0) {
      if (retryQueue.length > 0) {
        raceQuestions = shuffle([...retryQueue]);
        retryQueue = [];
      } else {
        finishRace();
        return;
      }
    }

    currentQData = raceQuestions[0];
    selectedChoices = [];

    const totalRem = raceQuestions.length + retryQueue.length;
    document.getElementById('q-remain-count').textContent = totalRem;

    const isMulti = currentQData.a.length > 1;
    
    const qArea = document.getElementById('question-area');
    qArea.innerHTML = '';

    const qText = document.createElement('div');
    qText.className = 'question-text';
    qText.innerHTML = (isMulti ? "<span style='color:#e67e22;font-weight:bold;'>[è¤‡æ•°é¸æŠ]</span> " : "") + currentQData.q;
    qArea.appendChild(qText);

    const grid = document.createElement('div');
    grid.className = 'choices-grid';
    
    currentQData.c.forEach((choice, idx) => {
      const btn = document.createElement('div');
      btn.className = 'choice-btn';
      btn.textContent = choice;
      const optId = idx + 1;
      
      btn.onclick = () => {
        if (isMulti) {
          toggleMultiChoice(btn, optId);
        } else {
          checkSingleAnswer(optId, btn);
        }
      };
      grid.appendChild(btn);
    });
    qArea.appendChild(grid);

    const cfmBtn = document.getElementById('confirm-btn');
    cfmBtn.style.display = isMulti ? 'block' : 'none';
  }

  function toggleMultiChoice(btn, id) {
    if (selectedChoices.includes(id)) {
      selectedChoices = selectedChoices.filter(x => x !== id);
      btn.classList.remove('selected');
    } else {
      selectedChoices.push(id);
      btn.classList.add('selected');
    }
  }

  function submitMultiAnswer() {
    if (selectedChoices.length === 0) return;
    
    const correctSorted = [...currentQData.a].sort().toString();
    const userSorted = [...selectedChoices].sort().toString();
    const isCorrect = (correctSorted === userSorted);
    
    showFeedback(isCorrect);
  }

  function checkSingleAnswer(id, btn) {
    const isCorrect = currentQData.a.includes(id);
    btn.classList.add(isCorrect ? 'correct' : 'wrong');
    showFeedback(isCorrect);
  }

  function showFeedback(isCorrect) {
    stopTimer();

    const overlay = document.getElementById('feedback-overlay');
    const title = document.getElementById('fb-title');
    const text = document.getElementById('fb-text');
    
    overlay.style.display = 'flex';
    
    if (isCorrect) {
      title.textContent = "â­• æ­£è§£ï¼";
      title.className = "fb-title fb-correct";
      text.textContent = currentQData.e;
      raceQuestions.shift();
      
      // æ­£è§£ï¼šé¦¬ç¾¤ã‚ˆã‚Šå‰ã¸ï¼ˆå³ã¸ç§»å‹•ï¼‰
      if (playerPosition < MAX_POS) {
        playerPosition += STEP_POS;
      }
      updatePlayerPositionVisual();

    } else {
      title.textContent = "âŒ ä¸æ­£è§£...";
      title.className = "fb-title fb-wrong";
      text.textContent = "æ­£è§£ã¯: " + currentQData.e;
      
      const q = raceQuestions.shift();
      retryQueue.push(q);
      
      // ä¸æ­£è§£ï¼šé¦¬ç¾¤ã‚ˆã‚Šå¾Œã‚ã¸ï¼ˆå·¦ã¸ç§»å‹•ï¼‰
      if (playerPosition > MIN_POS) {
        playerPosition -= STEP_POS;
      }
      updatePlayerPositionVisual();
    }
  }

  function nextQuestion() {
    document.getElementById('feedback-overlay').style.display = 'none';
    startTimer();
    showQuestion();
  }

  // === çµæœå‡¦ç† ===
  function finishRace() {
    stopTimer();
    
    // ã‚´ãƒ¼ãƒ«æ¼”å‡ºï¼šä¸€æ°—ã«å³ç«¯ã¸èµ°ã‚ŠæŠœã‘ã‚‹
    playerPosition = 120; // ç”»é¢å¤–ã¸
    updatePlayerPositionVisual();
    
    // 0.5ç§’å¾…ã£ã¦ã‹ã‚‰çµæœç”»é¢ã¸ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã›ã‚‹ãŸã‚ï¼‰
    setTimeout(() => {
      showResultScreen();
    }, 600);
  }

  function showResultScreen() {
    const finishTime = totalElapsed / 1000;
    
    document.getElementById('screen-race').classList.remove('active');
    document.getElementById('screen-result').classList.add('active');
    
    document.getElementById('result-time-val').textContent = finishTime.toFixed(2);
    
    const cls = CLASSES[currentClassId];
    const target = cls.target;
    
    document.getElementById('res-target').textContent = target + "ç§’";
    document.getElementById('res-target-2').textContent = (target + 2) + "ç§’";
    document.getElementById('res-target-3').textContent = (target + 5) + "ç§’";

    let rank = 6;
    if (finishTime <= target) rank = 1;
    else if (finishTime <= target + 2) rank = 2;
    else if (finishTime <= target + 5) rank = 3;
    else if (finishTime <= target + 8) rank = 4;
    else if (finishTime <= target + 11) rank = 5;

    const rankText = document.getElementById('result-rank-text');
    const rankEmoji = document.getElementById('result-emoji');
    const msg = document.getElementById('promotion-message');
    const nextBtn = document.getElementById('next-race-btn');

    if (rank === 1) {
      rankText.textContent = "1ç€";
      rankText.style.color = "#e67e22";
      rankEmoji.textContent = "ğŸ¥‡";
      handlePromotion();
    } else if (rank <= 5) {
      rankText.textContent = rank + "ç€";
      rankText.style.color = "#34495e";
      rankEmoji.textContent = "ğŸ¥ˆ";
      msg.innerHTML = `æƒœæ•—...<br>ã“ã®ã‚¯ãƒ©ã‚¹(${cls.name})ã§å†æŒ‘æˆ¦ã§ã™ã€‚<br>ã‚ã¨${(finishTime - target).toFixed(2)}ç§’çŸ­ç¸®ã—ã¾ã—ã‚‡ã†ã€‚`;
      nextBtn.textContent = "å†æŒ‘æˆ¦ã™ã‚‹";
    } else {
      rankText.textContent = "ç€å¤–";
      rankText.style.color = "#95a5a6";
      rankEmoji.textContent = "â˜ï¸";
      msg.innerHTML = `ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼...<br>è«¦ã‚ãšã«èµ°ã‚Šç¶šã‘ã¾ã—ã‚‡ã†ã€‚`;
      nextBtn.textContent = "å†æŒ‘æˆ¦ã™ã‚‹";
    }
    
    if (rank > 1) {
      handleDemotion(rank);
    }
  }

  function handlePromotion() {
    const msg = document.getElementById('promotion-message');
    const nextBtn = document.getElementById('next-race-btn');
    
    if (currentClassId < 9) { // G1æœªæº€
      currentClassId++;
      const nextName = CLASSES[currentClassId].name;
      msg.innerHTML = `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>ã€Œ${nextName}ã€ã¸æ˜‡æ ¼ã—ã¾ã—ãŸï¼`;
      nextBtn.textContent = "æ¬¡ã®ã‚¯ãƒ©ã‚¹ã¸";
    } 
    else if (currentClassId === 9) { // G1å‹åˆ©
      currentClassId = 10;
      msg.innerHTML = `G1åˆ¶è¦‡é”æˆï¼ï¼<br>ç‰¹åˆ¥æ‹›å¾…:ã€Œæœ‰é¦¬è¨˜å¿µã€ã¸æŒ‘æˆ¦ã—ã¾ã™ï¼`;
      nextBtn.textContent = "æœ‰é¦¬è¨˜å¿µã¸";
      alert("ğŸ‰ G1åˆ¶è¦‡ï¼æœ‰é¦¬è¨˜å¿µã¸ã®å‡ºèµ°æ¨©ã‚’ç²å¾—ã—ã¾ã—ãŸï¼");
    }
    else if (currentClassId === 10) { // æœ‰é¦¬å‹åˆ©
      currentClassId = 11;
      msg.innerHTML = `ã‚°ãƒ©ãƒ³ãƒ—ãƒªåˆ¶è¦‡ï¼ï¼<br>ã„ã–ã€ä¸–ç•Œã¸ã€‚ã€Œå‡±æ—‹é–€è³ã€æŒ‘æˆ¦ï¼`;
      nextBtn.textContent = "ãƒ•ãƒ©ãƒ³ã‚¹ã¸é å¾";
      alert("ğŸ† æœ‰é¦¬è¨˜å¿µå„ªå‹ï¼å‡±æ—‹é–€è³ã¸æŒ‘æˆ¦ã—ã¾ã™ï¼");
    }
    else if (currentClassId === 11) { // å‡±æ—‹é–€å‹åˆ©
      currentClassId = 9;
      msg.innerHTML = `ğŸ‡«ğŸ‡· å‡±æ—‹é–€è³åˆ¶è¦‡ï¼ï¼<br>ä¸–ç•Œæœ€å¼·ã®è¨¼æ˜å®Œäº†ã§ã™ã€‚<br>G1æˆ¦ç·šã¸å‡±æ—‹ã—ã¾ã™ã€‚`;
      nextBtn.textContent = "å¸°å›½ã™ã‚‹";
      alert("ğŸ‡«ğŸ‡· å‡±æ—‹é–€è³åˆ¶è¦‡ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼");
    }
    
    localStorage.setItem('vetQuizClassId', currentClassId);
  }

  function handleDemotion(rank) {
    const msg = document.getElementById('promotion-message');
    if (currentClassId === 10) {
      currentClassId = 9;
      msg.innerHTML += `<br>æ®‹å¿µ... G1ã‚¯ãƒ©ã‚¹ã¸æˆ»ã‚Šã¾ã™ã€‚`;
    } 
    else if (currentClassId === 11) {
      currentClassId = 9;
      msg.innerHTML += `<br>ä¸–ç•Œã®å£ã¯åšã‹ã£ãŸ... G1ã¸æˆ»ã‚Šã¾ã™ã€‚`;
    }
    else if (currentClassId === 9) {
      currentClassId = 8;
      msg.innerHTML += `<br>é™æ ¼... G2ã‹ã‚‰ç«‹ã¦ç›´ã—ã¾ã—ã‚‡ã†ã€‚`;
    }
    localStorage.setItem('vetQuizClassId', currentClassId);
  }

</script>
</body>
</html>