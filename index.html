<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --primary: #2c3e50;
      --main-btn: #3498db;
      --accent: #27ae60;
      --bg: #f4f7f6;
      --grass: #7cfc00;
      --track: #d2b48c;
      --gold: #f1c40f;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 0;
      color: #333;
      touch-action: manipulation;
      overflow-x: hidden;
    }

    /* === ãƒ¬ãƒ¼ã‚¹ç”»é¢ï¼ˆä¸Šéƒ¨ï¼‰ === */
    .race-monitor {
      background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 60%, var(--grass) 60%, var(--grass) 75%, var(--track) 75%);
      height: 250px;
      position: relative;
      overflow: hidden;
      border-bottom: 4px solid #5d4037;
    }

    .class-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 100;
      font-size: 14px;
      border: 1px solid rgba(255,255,255,0.5);
    }
    .badge-gold {
      background: linear-gradient(45deg, #f39c12, #f1c40f);
      color: #2c3e50;
      border: 1px solid #fff;
      box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
    }

    .time-display {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 5px 15px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 18px;
      z-index: 100;
    }

    /* === é¦¬ã®ã‚¹ã‚¿ã‚¤ãƒ« === */
    .horse-sprite {
      font-size: 50px;
      line-height: 1;
      user-select: none;
      filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.3));
      position: absolute;
      transform: scaleX(-1); /* å³å‘ã */
      transition: left 0.8s ease-out;
      will-change: transform, left;
    }

    /* é¦¬ã®è‰²ãƒ•ã‚£ãƒ«ã‚¿ */
    .horse-brown { filter: sepia(0.6) saturate(2) hue-rotate(-20deg) drop-shadow(2px 2px 2px rgba(0,0,0,0.4)); }
    .horse-black { filter: brightness(0.3) drop-shadow(2px 2px 2px rgba(0,0,0,0.4)); }
    .horse-gray  { filter: grayscale(1) brightness(1.3) drop-shadow(2px 2px 2px rgba(0,0,0,0.4)); }
    
    .horse-rival {
      font-size: 40px;
      opacity: 0.9;
      filter: grayscale(0.3) brightness(0.9);
      z-index: 1;
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¦¬ */
    #player-horse {
      font-size: 70px;
      z-index: 10;
      top: 55%;
    }

    .anim-run { animation: gallop 0.4s infinite linear; }
    .anim-stumble { animation: stumble 0.8s ease-in-out; }

    @keyframes gallop {
      0% { transform: scaleX(-1) translateY(0) rotate(0deg); }
      25% { transform: scaleX(-1) translateY(-3px) rotate(2deg); }
      50% { transform: scaleX(-1) translateY(0) rotate(0deg); }
      75% { transform: scaleX(-1) translateY(-1px) rotate(-2deg); }
      100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
    }
    @keyframes stumble {
      0% { transform: scaleX(-1) rotate(0deg); }
      20% { transform: scaleX(-1) rotate(-15deg) translateY(5px); }
      40% { transform: scaleX(-1) rotate(10deg); }
      60% { transform: scaleX(-1) rotate(-5deg); }
      100% { transform: scaleX(-1) rotate(0deg); }
    }

    /* å®Ÿæ³å¹ãå‡ºã— */
    .commentary-box {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: bold;
      font-size: 14px;
      max-width: 200px;
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      z-index: 101;
    }
    .commentary-box::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      margin-left: -10px;
      border-width: 10px 10px 0 10px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    .show-comment { opacity: 1; }

    /* === ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ === */
    .quiz-container { padding: 15px; max-width: 600px; margin: 0 auto; }
    .progress-bar { height: 8px; background: #ddd; border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--main-btn); width: 0%; transition: width 0.3s; }
    
    .question-text {
      font-size: 16px; line-height: 1.6; margin-bottom: 20px; font-weight: bold;
      background: #fff; padding: 20px; border-top: 4px solid var(--main-btn);
      box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 8px; color: #2c3e50;
      max-height: 40vh; overflow-y: auto;
    }
    
    .multi-badge { background: var(--main-btn); color: white; font-size: 12px; padding: 3px 8px; border-radius: 12px; vertical-align: middle; margin-right: 8px; font-weight: normal; }
    .choices-grid { display: grid; gap: 12px; }
    .choice-btn {
      background: #fff; border: 2px solid #e0e0e0; padding: 15px; border-radius: 10px;
      text-align: left; font-size: 15px; cursor: pointer; transition: all 0.2s; position: relative; color: #555;
    }
    .choice-btn:active { transform: scale(0.98); }
    .choice-btn.selected { border-color: var(--main-btn); background-color: #eaf6ff; color: var(--main-btn); font-weight: bold; }
    .choice-btn.correct { background-color: #d4edda; border-color: #28a745; color: #155724; }
    .choice-btn.wrong { background-color: #f8d7da; border-color: #e74c3c; color: #721c24; }
    
    .action-btn {
      background: var(--main-btn); color: white; border: none; padding: 16px; width: 100%;
      font-size: 18px; font-weight: bold; border-radius: 30px; margin-top: 25px;
      cursor: pointer; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); transition: background 0.2s;
    }
    .action-btn:hover { background: #2980b9; }
    .action-btn:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; }

    /* === ç”»é¢åˆ‡ã‚Šæ›¿ãˆ === */
    .screen { display: none; }
    .active { display: block; }
    .center-screen { text-align: center; padding: 40px 20px; max-width: 600px; margin: 0 auto; }
    .title-logo { font-size: 28px; margin-bottom: 10px; color: var(--primary); font-weight: 900; letter-spacing: 1px; }
    .title-sub { font-size: 16px; color: #7f8c8d; margin-bottom: 30px; display: block; }
    .start-btn { background: var(--main-btn); animation: gentle-pulse 2s infinite; }
    @keyframes gentle-pulse {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(52, 152, 219, 0); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }
    .loading { font-size: 14px; color: #95a5a6; margin-top: 20px; }
    .ending-bg { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
    .trophy-anim { font-size: 80px; margin: 20px 0; animation: popTrophy 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popTrophy {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    /* === ã‚«ãƒ†ã‚´ãƒªé¸æŠ === */
    .cat-select-container {
      margin-bottom: 20px;
    }
    .cat-select-label {
      text-align: left; font-weight: bold; color: #555; margin-bottom: 8px; font-size: 14px;
    }
    .cat-buttons {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
    }
    .cat-btn {
      padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; font-weight: bold; color: #7f8c8d;
    }
    .cat-btn.selected {
      background: var(--primary); color: #fff; border-color: var(--primary);
    }

    /* === é¦¬é¸æŠãƒœã‚¿ãƒ³ === */
    .horse-select-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 30px;
    }
    .horse-select-item {
      border: 2px solid #ddd; border-radius: 10px; padding: 10px; cursor: pointer; transition: all 0.2s; background: #fff;
    }
    .horse-select-item:hover { border-color: #aaa; }
    .horse-select-item.selected {
      border-color: var(--main-btn); background: #eaf6ff; box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
    }
    .horse-select-preview {
      font-size: 40px; margin-bottom: 5px; display: block; transform: scaleX(-1);
    }
    .horse-select-label { font-size: 14px; font-weight: bold; color: #555; }
    
    #current-horse-display {
      background: #fff; padding: 10px 20px; border-radius: 30px; display: inline-flex; align-items: center; gap: 10px; margin-bottom: 20px; border: 1px solid #ddd;
    }
  </style>
</head>
<body>

  <!-- 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
  <div id="screen-loading" class="screen active center-screen">
    <h2>å‡ºèµ°æº–å‚™ä¸­...</h2>
    <div class="loading">
      ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼šä¸­...<br>
      <span style="font-size:12px; color:#bdc3c7;">(å•é¡Œæ•°ãŒå¤šã„å ´åˆã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™)</span>
    </div>
  </div>

  <!-- 2. ã‚¿ã‚¤ãƒˆãƒ«/è¨­å®š/ã‚¯ãƒ©ã‚¹ç¢ºèªç”»é¢ -->
  <div id="screen-start" class="screen center-screen">
    <div class="title-logo">ğŸ† GIåˆ¶è¦‡ã¸ã®é“</div>
    <span class="title-sub">ã€œå­¦èª¬ABå•é¡Œ å®Œå…¨æ”»ç•¥ã€œ</span>

    <!-- è¨­å®šã‚¨ãƒªã‚¢ï¼ˆæ–°é¦¬æˆ¦ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div id="setup-area-wrapper">
      
      <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
      <div class="cat-select-container">
        <div class="cat-select-label">å‡ºé¡Œç¯„å›²:</div>
        <div class="cat-buttons">
          <div class="cat-btn selected" onclick="selectCategory('A')" id="cat-a">Aå•é¡Œ</div>
          <div class="cat-btn" onclick="selectCategory('B')" id="cat-b">Bå•é¡Œ</div>
          <div class="cat-btn" onclick="selectCategory('ALL')" id="cat-all">ç·åˆ</div>
        </div>
      </div>

      <!-- é¦¬é¸æŠ -->
      <div class="cat-select-label">æ„›é¦¬ã‚’é¸æŠ:</div>
      <div class="horse-select-grid">
        <div class="horse-select-item selected" onclick="selectHorse('brown')" id="sel-brown">
          <span class="horse-select-preview horse-brown">ğŸ‡</span>
          <span class="horse-select-label">é¹¿æ¯›</span>
        </div>
        <div class="horse-select-item" onclick="selectHorse('black')" id="sel-black">
          <span class="horse-select-preview horse-black">ğŸ‡</span>
          <span class="horse-select-label">é»’é¹¿æ¯›</span>
        </div>
        <div class="horse-select-item" onclick="selectHorse('gray')" id="sel-gray">
          <span class="horse-select-preview horse-gray">ğŸ‡</span>
          <span class="horse-select-label">èŠ¦æ¯›</span>
        </div>
      </div>
    </div>

    <!-- ç¶™ç¶šãƒ—ãƒ¬ã‚¤æ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="current-status-display" style="display:none; flex-direction:column; align-items:center;">
       <div id="current-horse-display">
         <span style="font-size:12px; color:#666;">Partner:</span>
         <span id="current-horse-icon" class="horse-sprite" style="position:static; font-size:30px;">ğŸ‡</span>
       </div>
       <div style="font-size:12px; color:#999; margin-bottom:15px;" id="current-category-display"></div>
    </div>
    
    <div style="background:#fff; padding:20px; border-radius:15px; margin-bottom:30px; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
      <p style="font-size:12px; color:#95a5a6; margin:0 0 5px;">NEXT RACE</p>
      <h3 id="current-class-display" style="margin:0; font-size:24px; color:var(--primary);">G1 æœ‰é¦¬è¨˜å¿µ</h3>
      <div style="margin-top:10px; display:inline-block; background:#ecf0f1; padding:5px 15px; border-radius:20px; font-size:13px; color:#7f8c8d;">
        åŸºæº–ã‚¿ã‚¤ãƒ : <span id="target-time-display" style="font-weight:bold; color:#2c3e50;">100</span>ç§’
      </div>
    </div>

    <button class="action-btn start-btn" onclick="startRace()">ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ï¼(å‡ºèµ°)</button>
    
    <p style="font-size:12px; color:#bdc3c7; margin-top:40px; cursor:pointer;" onclick="resetData()">
      [é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹]
    </p>
  </div>

  <!-- 3. ãƒ¬ãƒ¼ã‚¹ç”»é¢ -->
  <div id="screen-race" class="screen">
    <div class="race-monitor" id="race-monitor">
      <div class="class-badge" id="race-class-badge">G1 æœ‰é¦¬è¨˜å¿µ</div>
      <div class="time-display" id="timer">00:00</div>
      <div class="commentary-box" id="commentary">ã„ã„è„šè‰²ã ï¼</div>
      <div id="rivals-container"></div>
      <div class="horse-sprite anim-run" id="player-horse" style="left:50%;">ğŸ‡</div>
    </div>

    <div class="quiz-container">
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
      <div id="quiz-content"></div>
      <button id="confirm-btn" class="action-btn" style="display:none;" onclick="submitAnswer()">æ±ºå®š</button>
      <button id="next-btn" class="action-btn" style="display:none;" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
    </div>
  </div>

  <!-- 4. çµæœç”»é¢ -->
  <div id="screen-result" class="screen center-screen ending-bg">
    <h2 id="result-title" style="color:#7f8c8d; font-size:16px;">RACE RESULT</h2>
    <div class="trophy-anim" id="rank-emoji">ğŸ¥‡</div>
    <h1 style="margin:0; font-size:32px; color:var(--primary);" id="rank-text">1ç€</h1>
    <div style="margin:20px 0; font-family:monospace; background:#fff; padding:10px; border-radius:8px; display:inline-block;">
      Time: <span id="final-time" style="font-weight:bold; font-size:20px;">00:00</span>
      <span style="font-size:12px; color:#95a5a6; margin-left:10px;">(åŸºæº–: <span id="result-target"></span>ç§’)</span>
    </div>
    <div id="result-message" style="margin: 20px 0; font-weight:bold; color:var(--main-btn); font-size:18px; line-height:1.5;"></div>
    <button class="action-btn" id="result-btn" onclick="goToTitle()">æ¬¡èµ°ã¸å‘ã‹ã†</button>
  </div>

<script>
  let allData = { single: [], multi: [] };
  
  // ã‚¯ãƒ©ã‚¹å®šç¾©ï¼ˆåŸºæº–ã‚¿ã‚¤ãƒ ã‚’20ç§’çŸ­ç¸® = å³ã—ãï¼‰
  const CLASSES = [
    { name: "æ–°é¦¬æˆ¦", target: 180, nextId: 2, failId: 1 },
    { name: "æœªå‹åˆ©æˆ¦", target: 180, nextId: 2, failId: 1 },
    { name: "1å‹ã‚¯ãƒ©ã‚¹", target: 160, nextId: 3, failId: 2 },
    { name: "2å‹ã‚¯ãƒ©ã‚¹", target: 150, nextId: 4, failId: 3 },
    { name: "3å‹ã‚¯ãƒ©ã‚¹", target: 140, nextId: 5, failId: 4 },
    { name: "ã‚ªãƒ¼ãƒ—ãƒ³", target: 130, nextId: 6, failId: 5 },
    { name: "ãƒªã‚¹ãƒ†ãƒƒãƒ‰(L)", target: 120, nextId: 7, failId: 6 },
    { name: "Gâ…¢", target: 110, nextId: 8, failId: 7 },
    { name: "Gâ…¡", target: 100, nextId: 9, failId: 8 },
    { name: "Gâ… ", target: 90, nextId: 10, failId: 9 },
    { name: "æœ‰é¦¬è¨˜å¿µ", target: 80, nextId: 11, failId: 9 },
    { name: "å‡±æ—‹é–€è³", target: 70, nextId: 9, failId: 9 }
  ];

  const COMMENTS_GOOD = ["å¿«èª¿ï¼", "ã„ã„è„šè‰²ã ï¼", "ãã®ã¾ã¾ãƒ¼ï¼", "ãƒŠã‚¤ã‚¹ãƒšãƒ¼ã‚¹ï¼", "æ‰‹å¿œãˆååˆ†ï¼", "æŠ˜ã‚Šåˆã£ã¦ã„ã‚‹ï¼", "æŠœç¾¤ã®æ‰‹å¿œãˆï¼", "ä½ç½®å–ã‚ŠãŒè‰¯ã„ï¼"];
  const COMMENTS_BAD = ["ãŠã£ã¨ï¼ï¼Ÿ", "ã©ã†ã—ãŸï¼ï¼Ÿ", "ã‹ã‹ã£ãŸã‹ï¼Ÿ", "å‰ãŒå£ï¼", "ãƒãƒ©ãƒ³ã‚¹ã‚’å´©ã—ãŸï¼", "å¾Œé€€ã—ãŸ...", "è‹¦ã—ã„å±•é–‹ï¼", "ç½®ã‹ã‚Œã¦ã„ã‚‹..."];

  let currentClassId = 0;
  let raceQuestions = [];
  let currentQIndex = 0;
  let currentQData = null;
  let selectedChoices = [];
  let startTime = 0;
  let timerInterval = null;
  let totalElapsed = 0;

  // ã‚²ãƒ¼ãƒ ç”¨çŠ¶æ…‹å¤‰æ•°
  let playerHorseColor = 'brown'; 
  let playerPosition = 50; 
  let selectedCategory = 'ALL'; // A, B, ALL

  const MAX_POS = 90;
  const MIN_POS = 10;
  
  window.onload = function() {
    const savedClass = localStorage.getItem('vetQuizClassId');
    if (savedClass) currentClassId = parseInt(savedClass, 10);
    if(currentClassId >= CLASSES.length) currentClassId = 0;

    // é¦¬ã®è‰²èª­ã¿è¾¼ã¿
    const savedColor = localStorage.getItem('vetQuizHorseColor');
    if (savedColor) playerHorseColor = savedColor;
    
    // ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿
    const savedCat = localStorage.getItem('vetQuizCategory');
    if (savedCat) selectedCategory = savedCat;

    updateStartScreen();
    // UIåˆæœŸåŒ–
    selectHorse(playerHorseColor, false);
    selectCategory(selectedCategory, false);

// index.html ã®ä¸€ç•ªä¸‹ã€</script> ã®ç›´å‰ã‚ãŸã‚Šã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚

/**
 * Python(Flask)ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦èµ·å‹•ã™ã‚‹
 */
function loadDataFromPython() {
  console.log("Pythonã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™...");
  
  // Flaskã§è¨­å®šã—ãŸURL (/api/quiz_data) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
  fetch('/api/quiz_data')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("ãƒ‡ãƒ¼ã‚¿å—ä¿¡æˆåŠŸ:", data);
      // å…ƒã€… index.html ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹æˆåŠŸæ™‚å‡¦ç†ã‚’å‘¼ã³å‡ºã™
      if (typeof onDataLoaded === 'function') {
        onDataLoaded(data);
      }
    })
    .catch(error => {
      console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
      // å…ƒã€… index.html ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¤±æ•—æ™‚å‡¦ç†ã‚’å‘¼ã³å‡ºã™
      if (typeof onDataError === 'function') {
        onDataError(error);
      }
    });
}

/**
 * ç”»é¢ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ã®å‡¦ç†
 * GASã®æ™‚ã¯ã“ã“ãŒç©ºã£ã½ã ã£ãŸã‚Š google.script.run ã ã£ãŸã‚Šã—ã¾ã—ãŸãŒã€
 * Pythonç‰ˆã§ã¯ä¸Šã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
 */
window.onload = function() {
  loadDataFromPython();
};

  function onDataLoaded(json) {
    const data = JSON.parse(json);
    allData = data;
    document.getElementById('screen-loading').classList.remove('active');
    document.getElementById('screen-start').classList.add('active');
  }

  function onDataError(e) { alert("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e); }

  function resetData() {
    if(confirm("é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°é¦¬æˆ¦ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
      currentClassId = 0;
      localStorage.setItem('vetQuizClassId', currentClassId);
      // ã‚«ãƒ†ã‚´ãƒªã‚„é¦¬ã¯ã‚ãˆã¦æ®‹ã™ã‹ã€ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã‹ã€‚ä»Šå›ã¯ã‚¯ãƒ©ã‚¹ã ã‘ãƒªã‚»ãƒƒãƒˆ
      updateStartScreen();
    }
  }

  // === è¨­å®šUIæ“ä½œ ===
  function selectCategory(cat, save=true) {
    selectedCategory = cat;
    // ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–°
    ['a', 'b', 'all'].forEach(id => {
      document.getElementById(`cat-${id}`).classList.remove('selected');
    });
    document.getElementById(`cat-${cat.toLowerCase()}`).classList.add('selected');
    
    if (save) localStorage.setItem('vetQuizCategory', cat);
  }

  function selectHorse(color, save=true) {
    playerHorseColor = color;
    ['brown', 'black', 'gray'].forEach(c => {
      document.getElementById(`sel-${c}`).classList.remove('selected');
    });
    document.getElementById(`sel-${color}`).classList.add('selected');

    if (save) localStorage.setItem('vetQuizHorseColor', color);
  }

  function updateStartScreen() {
    const cls = CLASSES[currentClassId];
    document.getElementById('current-class-display').textContent = cls.name;
    document.getElementById('target-time-display').textContent = cls.target;
    
    const titleEl = document.getElementById('current-class-display');
    if (currentClassId === 10) titleEl.style.color = "#d35400";
    else if (currentClassId === 11) titleEl.style.color = "#8e44ad";
    else titleEl.style.color = "var(--primary)";

    // æ–°é¦¬æˆ¦(0)ã®ã¿è¨­å®šè¡¨ç¤º
    const wrapper = document.getElementById('setup-area-wrapper');
    const statusDisplay = document.getElementById('current-status-display');
    
    if (currentClassId === 0) {
      wrapper.style.display = 'block';
      statusDisplay.style.display = 'none';
    } else {
      wrapper.style.display = 'none';
      statusDisplay.style.display = 'flex';
      
      const icon = document.getElementById('current-horse-icon');
      icon.className = `horse-sprite horse-${playerHorseColor}`;
      
      const catText = selectedCategory === 'ALL' ? 'ç·åˆ(A+B)' : selectedCategory + 'å•é¡Œ';
      document.getElementById('current-category-display').textContent = `ç¯„å›²: ${catText}`;
    }
  }

  // === å‡ºé¡Œãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ===
  function getFilteredQuestions(list) {
    if (selectedCategory === 'ALL') return list;
    // ãƒ‡ãƒ¼ã‚¿ã«ã¯ cat ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å‰æ (Code.gsä¿®æ­£æ¸ˆã¿)
    return list.filter(q => q.cat === selectedCategory);
  }

  function startRace() {
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const filteredSingle = getFilteredQuestions(allData.single);
    const filteredMulti = getFilteredQuestions(allData.multi);

    // ãƒ‡ãƒ¼ã‚¿ä¸è¶³ãƒã‚§ãƒƒã‚¯
    if (filteredSingle.length < 7 || filteredMulti.length < 3) {
      alert(`å•é¡Œæ•°ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚\n(å˜ä¸€: ${filteredSingle.length}å•, è¤‡æ•°: ${filteredMulti.length}å•)\nç¯„å›²ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
      return;
    }

    const singles = shuffle([...filteredSingle]).slice(0, 7);
    const multis = shuffle([...filteredMulti]).slice(0, 3);
    raceQuestions = [...singles, ...multis];
    
    currentQIndex = 0;
    totalElapsed = 0;
    playerPosition = 50; 
    
    document.getElementById('screen-start').classList.remove('active');
    document.getElementById('screen-race').classList.add('active');
    
    const badge = document.getElementById('race-class-badge');
    badge.textContent = CLASSES[currentClassId].name;
    if (currentClassId >= 9) badge.classList.add('badge-gold');
    else badge.classList.remove('badge-gold');
    
    const pHorse = document.getElementById('player-horse');
    pHorse.className = `horse-sprite anim-run horse-${playerHorseColor}`; 
    pHorse.textContent = 'ğŸ‡';
    updatePlayerPositionVisual();

    generateRivals();
    startTimer();
    showQuestion();
  }

  function generateRivals() {
    const container = document.getElementById('rivals-container');
    container.innerHTML = '';
    for(let i=0; i<7; i++) {
      const rival = document.createElement('div');
      rival.textContent = 'ğŸ‡';
      rival.className = 'horse-sprite anim-run horse-rival';
      const rTop = 45 + Math.random() * 25; 
      const rLeft = 10 + Math.random() * 80;
      rival.style.top = rTop + '%';
      rival.style.left = rLeft + '%';
      rival.style.animationDuration = (0.35 + Math.random() * 0.1) + 's';
      container.appendChild(rival);
    }
  }

  function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
      const now = Date.now();
      const diff = now - startTime + totalElapsed;
      const sec = Math.floor(diff / 1000);
      const ms = Math.floor((diff % 1000) / 10);
      document.getElementById('timer').textContent = sec + "." + (ms < 10 ? "0"+ms : ms);
      
      if (playerPosition > MIN_POS) {
        playerPosition -= 0.03; 
        updatePlayerPositionVisual();
      }
    }, 50);
  }
  
  function stopTimer() {
    clearInterval(timerInterval);
    totalElapsed += Date.now() - startTime;
  }

  function updatePlayerPositionVisual() {
    if(playerPosition > MAX_POS) playerPosition = MAX_POS;
    if(playerPosition < MIN_POS) playerPosition = MIN_POS;
    const pHorse = document.getElementById('player-horse');
    pHorse.style.left = playerPosition + '%';
  }

  function showQuestion() {
    if (raceQuestions.length === 0) {
      finishRace();
      return;
    }

    currentQData = raceQuestions[0];
    selectedChoices = [];
    
    const isMulti = currentQData.a.length > 1;
    const badgeText = isMulti ? '2ã¤é¸ã¹' : '1ã¤é¸ã¹';
    const badgeStyle = isMulti ? 'background:#e67e22' : 'background:var(--main-btn)';
    
    let html = `<div class="question-text">
                  <span class="multi-badge" style="${badgeStyle}">${badgeText}</span>
                  ${currentQData.q}
                </div>`;
    html += `<div class="choices-grid">`;
    
    currentQData.c.forEach((choiceText, idx) => {
      const choiceNum = idx + 1;
      html += `<div class="choice-btn" id="choice-${choiceNum}" onclick="selectChoice(${choiceNum}, ${isMulti})">
        <span style="font-weight:bold; color:#aaa; margin-right:10px;">${choiceNum}.</span>${choiceText}
      </div>`;
    });
    html += `</div>`;

    document.getElementById('quiz-content').innerHTML = html;
    
    const totalInit = 10; 
    const current = Math.max(0, totalInit - raceQuestions.length); 
    const pct = (current / totalInit) * 100;
    document.getElementById('progress-fill').style.width = pct + "%";

    document.getElementById('confirm-btn').style.display = isMulti ? 'block' : 'none';
    document.getElementById('confirm-btn').disabled = true;
    document.getElementById('next-btn').style.display = 'none';
    
    updateHorse('run');
    hideCommentary();
  }

  function selectChoice(num, isMulti) {
    if (document.getElementById('next-btn').style.display === 'block') return;

    if (isMulti) {
      const idx = selectedChoices.indexOf(num);
      if (idx >= 0) {
        selectedChoices.splice(idx, 1);
        document.getElementById(`choice-${num}`).classList.remove('selected');
      } else {
        if (selectedChoices.length < 2) {
          selectedChoices.push(num);
          document.getElementById(`choice-${num}`).classList.add('selected');
        }
      }
      document.getElementById('confirm-btn').disabled = (selectedChoices.length !== 2);
    } else {
      selectedChoices = [num];
      for(let i=1; i<=5; i++) {
        const el = document.getElementById(`choice-${i}`);
        if(el) el.classList.remove('selected');
      }
      document.getElementById(`choice-${num}`).classList.add('selected');
      submitAnswer();
    }
  }

  function submitAnswer() {
    stopTimer();
    document.getElementById('confirm-btn').style.display = 'none';

    const correctArr = currentQData.a.sort((a,b)=>a-b);
    const userArr = selectedChoices.sort((a,b)=>a-b);
    const isCorrect = JSON.stringify(correctArr) === JSON.stringify(userArr);

    correctArr.forEach(n => {
      const el = document.getElementById(`choice-${n}`);
      if(el) el.classList.add('correct');
    });

    if (isCorrect) {
      playerPosition += 12; 
      updatePlayerPositionVisual();
      playCommentary(true);
      updateHorse('run');
      raceQuestions.shift();
      setTimeout(() => { nextQuestion(); }, 1200);
    } else {
      playerPosition -= 12; 
      updatePlayerPositionVisual();
      userArr.forEach(n => {
        if (!correctArr.includes(n)) {
          const el = document.getElementById(`choice-${n}`);
          if(el) el.classList.add('wrong');
        }
      });
      playCommentary(false);
      updateHorse('stumble');
      const missedQ = raceQuestions.shift();
      raceQuestions.push(missedQ);
      
      const expDiv = document.createElement('div');
      expDiv.style.marginTop = "15px"; expDiv.style.padding = "15px"; expDiv.style.background = "#fff3cd"; expDiv.style.color = "#856404"; expDiv.style.borderRadius = "8px";
      expDiv.innerHTML = `<strong>è§£èª¬:</strong><br>${currentQData.e || 'ï¼ˆè§£èª¬ãªã—ï¼‰'}`;
      document.getElementById('quiz-content').appendChild(expDiv);
      document.getElementById('next-btn').style.display = 'block';
    }
  }

  function nextQuestion() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
      const now = Date.now();
      const diff = now - startTime + totalElapsed;
      const sec = Math.floor(diff / 1000);
      const ms = Math.floor((diff % 1000) / 10);
      document.getElementById('timer').textContent = sec + "." + (ms < 10 ? "0"+ms : ms);
      if (playerPosition > MIN_POS) {
        playerPosition -= 0.03; 
        updatePlayerPositionVisual();
      }
    }, 50);
    showQuestion();
  }

  function updateHorse(state) {
    const horse = document.getElementById('player-horse');
    if (state === 'stumble') {
      horse.classList.remove('anim-run'); horse.classList.add('anim-stumble'); horse.textContent = 'ğŸ˜µ';
    } else {
      horse.classList.remove('anim-stumble'); horse.classList.add('anim-run'); horse.textContent = 'ğŸ‡';
    }
  }

  function playCommentary(isGood) {
    const arr = isGood ? COMMENTS_GOOD : COMMENTS_BAD;
    const text = arr[Math.floor(Math.random() * arr.length)];
    const box = document.getElementById('commentary');
    box.textContent = text;
    box.classList.add('show-comment');
    setTimeout(() => { box.classList.remove('show-comment'); }, 3000);
  }

  function hideCommentary() {
    document.getElementById('commentary').classList.remove('show-comment');
  }

  function finishRace() {
    stopTimer();
    document.getElementById('screen-race').classList.remove('active');
    document.getElementById('screen-result').classList.add('active');

    const finalSec = Math.floor(totalElapsed / 1000);
    const target = CLASSES[currentClassId].target;
    document.getElementById('final-time').textContent = document.getElementById('timer').textContent;
    document.getElementById('result-target').textContent = target;

    let rank = 6;
    const diff = finalSec - target;
    if (diff <= 0) rank = 1; else if (diff <= 2) rank = 2; else if (diff <= 4) rank = 3; else if (diff <= 6) rank = 4; else if (diff <= 8) rank = 5;

    const rankTextEl = document.getElementById('rank-text');
    const rankEmojiEl = document.getElementById('rank-emoji');
    const msgEl = document.getElementById('result-message');
    const btnEl = document.getElementById('result-btn');

    if (rank === 1) {
      rankTextEl.textContent = "1ç€"; rankTextEl.style.color = "#f39c12"; rankEmojiEl.textContent = "ğŸ†";
      const nextId = CLASSES[currentClassId].nextId;

      if (currentClassId === 9) { 
        msgEl.innerHTML = `G1å…¨åˆ¶è¦‡ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br><span style="font-size:14px; color:#555;">ãƒ•ã‚¡ãƒ³æŠ•ç¥¨ã§é¸å‡ºã•ã‚Œã¾ã—ãŸï¼ã‚°ãƒ©ãƒ³ãƒ—ãƒªãƒ»æœ‰é¦¬è¨˜å¿µã¸æŒ‘æˆ¦ï¼</span>`;
        btnEl.textContent = "ã‚°ãƒ©ãƒ³ãƒ—ãƒª(æœ‰é¦¬è¨˜å¿µ)ã¸";
        currentClassId = 10;
      } else if (currentClassId === 10) { 
        msgEl.innerHTML = `ã‚°ãƒ©ãƒ³ãƒ—ãƒªåˆ¶è¦‡ï¼æ—¥æœ¬ä¸€ã®ç§°å·ã‚’ç²å¾—ï¼<br><span style="font-size:14px; color:#555;">ã•ã‚ã€ä¸–ç•Œã¸ã®æŒ‘æˆ¦æ¨©(å‡±æ—‹é–€è³)ç²å¾—ã§ã™ï¼</span>`;
        btnEl.textContent = "ä¸–ç•Œ(å‡±æ—‹é–€è³)ã¸æŒ‘æˆ¦";
        currentClassId = 11;
      } else if (currentClassId === 11) { 
        msgEl.innerHTML = `ä¸–ç•Œåˆ¶è¦‡ï¼å‡±æ—‹é–€è³ å„ªå‹ï¼<br>ã‚ãªãŸã¯ä¼èª¬ã«ãªã‚Šã¾ã—ãŸã€‚<br><span style="font-size:14px; color:#555;">(G1é˜²è¡›æˆ¦ã¸æˆ»ã‚Šã¾ã™)</span>`;
        btnEl.textContent = "å‡±æ—‹å¸°å›½ (G1ã¸)";
        currentClassId = 9;
      } else {
        msgEl.textContent = "è¦‹äº‹å‹åˆ©ï¼æ¬¡ã®ã‚¯ãƒ©ã‚¹ã¸æ˜‡æ ¼ï¼";
        btnEl.textContent = "æ¬¡ã®ãƒ¬ãƒ¼ã‚¹ã¸";
        currentClassId = nextId;
      }
      localStorage.setItem('vetQuizClassId', currentClassId);
    } else {
      const failId = CLASSES[currentClassId].failId;
      if (rank <= 5) {
        rankTextEl.textContent = rank + "ç€"; rankTextEl.style.color = "#34495e"; rankEmojiEl.textContent = "ğŸ¥ˆ";
        msgEl.textContent = "æƒœæ•—... ã“ã®ã‚¯ãƒ©ã‚¹ã§å†æŒ‘æˆ¦ã§ã™ã€‚";
      } else {
        rankTextEl.textContent = "ç€å¤–"; rankTextEl.style.color = "#95a5a6"; rankEmojiEl.textContent = "â˜ï¸";
        msgEl.textContent = "æ®‹å¿µ... ã¾ã ã¾ã å¼·ããªã‚Œã‚‹ï¼æ¬¡èµ°ã“ãå‹åˆ©ã‚’ï¼";
      }

      if (currentClassId === 10 && rank > 1) {
        msgEl.innerHTML += "<br><span style='color:#e74c3c'>å¤¢ã®ç¶šãã¯ã¾ãŸæ¬¡èµ°... G1æˆ¦ç·šã§åŠ›ã‚’è“„ãˆã¾ã—ã‚‡ã†ï¼</span>";
        btnEl.textContent = "G1æˆ¦ç·šã¸æˆ»ã‚‹";
        currentClassId = 9;
      } else if (currentClassId === 11) {
        msgEl.innerHTML = "ä¸–ç•Œã®å£ã¯åšã‹ã£ãŸ...<br><span style='font-size:14px'>(G1é˜²è¡›æˆ¦ã¸æˆ»ã‚Šã¾ã™)</span>";
        btnEl.textContent = "å¸°å›½ã™ã‚‹ (G1ã¸)";
        currentClassId = 9;
      } else if (currentClassId === 0) {
         if(currentClassId !== failId) {
             msgEl.textContent += " æœªå‹åˆ©æˆ¦ã¸å‘ã‹ã„ã¾ã™ã€‚";
             currentClassId = failId;
         }
      } else {
         currentClassId = failId; 
      }
      localStorage.setItem('vetQuizClassId', currentClassId);
    }
  }

  function goToTitle() {
    document.getElementById('screen-result').classList.remove('active');
    updateStartScreen();
    document.getElementById('screen-start').classList.add('active');
  }
  
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }
</script>
</body>
</html>